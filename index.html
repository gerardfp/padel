<!DOCTYPE html>
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<style>

		summary {
			font-weight: bold;
			padding: 1em;
		}

	</style>
</head>
<!--
alberto
blanca
carlos
david 
eugenio 
fernando 
gerard
hector
ismael
jordi
kevin andres miguel
luis miguel
manuel
nestor
octavio
paco
-->
<div style="font-family:sans-seriff; margin: auto; max-width: 800px; display: flex; flex-direction: column; gap: 2.2em;align-items: center;">

		<div id="configScreen" style="padding:0.5em; background: rgb(249, 198, 103); display: flex; flex-direction: column; width: 100%;">
			<details open>
				<summary>JUGADORS</summary>
			<textarea id="inputplayers" rows=18 cols=40>
alberto
blanca
carlos
david 
eugenio 
fernando 
gerard
hector
ismael
jordi
kevin andres miguel
luis miguel
manuel
nestor
octavio
paco
			</textarea>
			<p>Total: <span id="numPlayersSpan"></span></p>
			<button id="startButton" style="padding:0.8em">INICIAR TORNEIG</button>
		</details>
		</div>
	

	<div id="tournamentScreen" style="padding:0.5em; width: 100%; background: rgb(192, 247, 108); display: flex; flex-direction: column;"  >
		<details open>
		<summary>RONDA <span id="roundNumSpan"></span></summary>
		<div id="currentMatchesDiv"></div>
		<button style="padding:0.8em" id="newRoundButton">NOVA RONDA</button>
	</details>
	</div>

	<div id="resultatsScreen" style="padding:0.5em; width: 100%; background: rgb(241, 169, 241); display: flex; flex-direction: column;"  >
		<details open>
			<summary>RESULTATS</summary>
			<div id="allMatchesDiv"></div>
			<button style="padding:0.8em" id="updateScoresButton">ACTUALITZAR RESULTATS</button> 
		</details>
	</div>

	<div id="clasificacioScreen" style="padding:0.5em; width: 100%; background: rgb(238, 130, 130); display: flex; flex-direction: column;"  >
		<details open>
			<summary>CLASIFICACIO</summary>
			<div id="clasificacioDiv"></div>
		</details>
	</div>

</div>



<script>


let players = [];
let allMatches = {};
let currentMatches = [];
let currentRound = 0;

actualitzaPlayers();
newRound();
showAllMatches();
showClasificacio();

inputplayers.oninput = (e) => {
	actualitzaPlayers();
}

startButton.onclick = (e) => {
	allMatches = {};
	currentMatches = [];
	currentRound = 0;
	newRound();
}

newRoundButton.onclick = (e) => {
	newRound();
	showAllMatches();
}

updateScoresButton.onclick = () => {
	saveAllMatches();
	showAllMatches();
	showClasificacio();
}


function actualitzaPlayers(){
	players = inputplayers.value.split('\n').map(row => row.trim()).filter(row => row.trim().length > 0);
	numPlayersSpan.innerText=players.length;	
}


function newRound() {
	currentRound++;

	roundNumSpan.innerText = currentRound;

	const numMatches = Math.floor(players.length / 4);
	const available = [...players];
	currentMatches = [];

	while(currentMatches.length < numMatches){

		const match = {};

		match.id = makeid();
		match.round = currentRound;
		match.p1 = getRandom(available);
		match.p2 = getRandom(available);
		match.p3 = getRandom(available);
		match.p4 = getRandom(available);
		match.points12 = 0;
		match.points34 = 0;
			
		currentMatches.push(match);
	}
	
	let ih = "";
	let i = 1;
	for (const match of currentMatches) {
		ih += `
		<div style="margin-bottom:1em; background:lightgray; border:1px solid black; ">
			<div>Pista ${i}</div>
			<div style="text-align:center">
				<div style="background:lightblue">${match.p1} - ${match.p2}</div>
				<input id="${match.id}-12" oninput="saveAllMatches()" type="number" style="padding:0.8em; width:3em;text-align:center; ">
			</div>
			<div style="background:#ff4466; text-align:center">VS</div>
			<div style="text-align:center">
				<input id="${match.id}-34" oninput="saveAllMatches()" type="number" style="padding:0.8em; width:3em;text-align:center;">
				<div style="background:lightblue">${match.p3} - ${match.p4}</div>
			</div>
		</div>
		`
		i++;
	}
	currentMatchesDiv.innerHTML = ih;

	allMatches[currentRound] = [...currentMatches];
}



function saveCurrentMatches(){
	for (const match of currentMatches) {
		match.points12 = document.querySelector(`#${match.id}-12`).value;
		match.points34 = document.querySelector(`#${match.id}-34`).value;	
	}
	
	//allMatches[currentRound] = [...currentMatches];
}

function saveAllMatches(e){
	console.log(document.querySelector(`#${e.target.id}`));
	for (const round in allMatches) {
		for (const match of allMatches[round]) {
			match.points12 = document.querySelector(`#${match.id}-12`)?.value | 0;
			match.points34 = document.querySelector(`#${match.id}-34`)?.value | 0;	
		}
	}

	// showAllMatches();
	// showClasificacio();
} 

function showAllMatches(){
	let ih = "";
	ih += `<table>`;
	for (const round in allMatches) {
		ih += `<tr><td colspan=5 style="text-align:center; background:gray;color:white ">Ronda ${round}</td></tr>`;
		
		for(const match of allMatches[round]){
			ih += `
				<tr><td style="width:40%; ">${match.p1} - ${match.p2}</td><td><input  oninput="saveAllMatches(event)" style="width:2em;" id="${match.id}-a" value="${match.points12}" /></td><td><span style="color:red">VS</span></td><td><input  oninput="saveAllMatches()" style="width:2em;" id="${match.id}-b" value="${match.points34}" /></td><td style="text-align:right; width:40%">${match.p3} - ${match.p4}</td></tr>
			`
		}
	}
	ih += `</table>`;
	allMatchesDiv.innerHTML = ih;
}

function showClasificacio(){
	const points = {};

	for (const round in allMatches) {
		for (const match of allMatches[round]) {
			points[match.p1] = (Number(points[match.p1]) | 0) + Number(match.points12);
			points[match.p2] = (Number(points[match.p2]) | 0) + Number(match.points12);
			points[match.p3] = (Number(points[match.p3]) | 0) + Number(match.points34);
			points[match.p4] = (Number(points[match.p4]) | 0) + Number(match.points34);
		}
	}	

	let ih = "";
	for (const player of Object.keys(points).sort((a, b) => {
  		return points[b] - points[a]
	})) {
		ih += `<p>${player}: ${points[player]}</p>`;
	}
	clasificacioDiv.innerHTML = ih;
}




function getRandom(array) {
	//return array[(Math.random() * array.length) | 0]
	return array.splice((Math.random() * array.length) | 0, 1)[0]
}



function makeid() {
    let result = '';
    const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz';
    const charactersLength = characters.length;
    let counter = 0;
    while (counter < 10) {
      result += characters.charAt(Math.floor(Math.random() * charactersLength));
      counter += 1;
    }
    return result;
}

// let pairs = [];

// function compareMatches(a,b) {
// 	return a.p1===b.p1 && a.p2===b.p2 && a.p3===b.p3 && a.p4===b.p4
// }

// function vaDavant(a,b) {
// 	if (a.charAt(0) < b.charAt(0)) {
// 		return true;
// 	}
// 	return false;
// }


// function pair() {
// 	let mts = [];

// 	for (let i=0; i<players.length; i++) {
// 		for (let j=i+1; j<players.length; j++) {
// 			for(let k=i+1; k<players.length; k++) {
// 				if (k==j) continue;
// 				for(let l=k+1; l<players.length; l++) {
// 					if (l==j || l==k) continue;
					
// 					pairs.push({p1:players[i], p2:players[j], p3:players[k], p4:players[l]});

// 					// console.log(`${players[i]} - ${players[j]}  VS ${players[k]} - ${players[l]}`);

// 					// let parella1 = `${players[i]}${players[j]}`
// 					// if(vaDavant(players[j], players[i])) {
// 					// 	parella1 = `${players[j]}${players[i]}`
// 					// }
// 					// let parella2 = `${players[k]}${players[l]}`
// 					// if(vaDavant(players[l], players[k])) {
// 					// 	parella2 = `${players[l]}${players[k]}`
// 					// }

// 					// let mstr = `${parella1}${parella2}`;
// 					// if(vaDavant(parella2, parella1)){
// 					// 	mstr = `${parella2}${parella1}` ;
// 					// }
// 					// mts.push(mstr)
// 				}
// 			}
// 		}
// 	}

// 	//mts.sort();
// 	//for(let i=0; i<mts.length; i++) {
// 	//	console.log(mts[i]);
// 	//}
// 	//console.log(mts.length);
// }

</script>


